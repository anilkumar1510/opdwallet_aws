name: Seed Medicine Database on AWS

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "seed" to confirm seeding the medicine database'
        required: true
        default: ''

jobs:
  seed-medicines:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "seed" ]; then
            echo "âŒ ERROR: You must type 'seed' to confirm"
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Seed Medicine Database on AWS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 5m
          script: |
            echo "ğŸŒ± Starting medicine database seeding on AWS..."

            cd ~/opdwallet_aws || { echo "âŒ ERROR: Cannot access opdwallet_aws directory"; exit 1; }

            # Pull latest code
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git pull origin main

            # Check if medicines.json exists
            if [ ! -f "api/src/scripts/medicines.json" ]; then
              echo "âŒ ERROR: medicines.json not found even after git pull."
              exit 1
            fi
            echo "âœ… Found medicines.json file"

            echo "ğŸ“Š Clearing existing medicines..."
            docker exec opd-mongodb-prod mongosh opd_wallet --quiet --eval "
              const count = db.medicine_database.countDocuments();
              print('Current medicines count: ' + count);
              db.medicine_database.deleteMany({});
              print('âœ… Cleared existing medicines');
            "

            echo "ğŸ“Š Importing medicines from JSON..."
            # Copy JSON file into the MongoDB container
            docker cp api/src/scripts/medicines.json opd-mongodb-prod:/tmp/medicines.json

            # Import using mongoimport
            docker exec opd-mongodb-prod mongoimport \
              --db opd_wallet \
              --collection medicine_database \
              --file /tmp/medicines.json \
              --jsonArray

            if [ $? -eq 0 ]; then
              echo "âœ… Medicine database seeded successfully!"

              # Create text index for search
              echo "ğŸ“Š Creating text index for search..."
              docker exec opd-mongodb-prod mongosh opd_wallet --quiet --eval "
                db.medicine_database.createIndex({
                  genericName: 'text',
                  brandNames: 'text',
                  searchText: 'text'
                });
                print('âœ… Text index created');
              "

              # Verify the count
              echo "ğŸ” Verifying medicine count in database..."
              docker exec opd-mongodb-prod mongosh opd_wallet --quiet --eval "
                const count = db.medicine_database.countDocuments();
                print('ğŸ“Š Total medicines in database: ' + count);
              "
            else
              echo "âŒ ERROR: Medicine seeding failed"
              exit 1
            fi

            echo "ğŸ‰ Medicine database setup complete!"

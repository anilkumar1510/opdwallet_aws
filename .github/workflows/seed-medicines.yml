name: Seed Medicine Database on AWS

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "seed" to confirm seeding the medicine database'
        required: true
        default: ''

jobs:
  seed-medicines:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "seed" ]; then
            echo "âŒ ERROR: You must type 'seed' to confirm"
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Seed Medicine Database on AWS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 5m
          script: |
            echo "ğŸŒ± Starting medicine database seeding on AWS..."

            cd ~/opdwallet_aws/api || { echo "âŒ ERROR: Cannot access opdwallet_aws/api directory"; exit 1; }

            echo "ğŸ“Š Running medicine seeding script..."
            docker exec opd-api-prod npm run seed:medicines

            if [ $? -eq 0 ]; then
              echo "âœ… Medicine database seeded successfully!"

              # Verify the count
              echo "ğŸ” Verifying medicine count in database..."
              docker exec opd-mongodb-prod mongosh opd_wallet --quiet --eval "
                db.medicine_database.countDocuments().then(count => {
                  print('ğŸ“Š Total medicines in database: ' + count);
                });
              "
            else
              echo "âŒ ERROR: Medicine seeding failed"
              exit 1
            fi

            echo "ğŸ‰ Medicine database setup complete!"

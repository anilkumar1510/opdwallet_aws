name: Deploy Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to EC2
      run: |
        # Setup SSH
        echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > deploy_key.pem
        chmod 600 deploy_key.pem

        # Deploy and build on EC2
        ssh -o StrictHostKeyChecking=no -i deploy_key.pem ubuntu@$EC2_HOST << 'EOF'
          set -e
          echo "üöÄ Starting deployment..."

          # Pull latest code
          cd /home/ubuntu/opdwallet
          git pull origin main

          # Stop existing containers
          docker-compose -f docker-compose.prod.yml down || true

          # Build with proper environment
          export DOCKER_DEFAULT_PLATFORM=linux/amd64
          docker-compose -f docker-compose.prod.yml build --no-cache

          # Start services
          docker-compose -f docker-compose.prod.yml up -d

          # Wait for services to be ready
          echo "‚è≥ Waiting for services..."
          sleep 15

          # Seed database if needed
          docker exec opdwallet-api-1 node dist/scripts/seed.js 2>/dev/null || echo "Database already seeded"

          # Health check
          echo "üîç Checking health..."
          curl -sf http://localhost/api/health || echo "API health endpoint not configured"
          curl -sf http://localhost || echo "Frontend check"

          # Show status
          docker-compose -f docker-compose.prod.yml ps
          echo "‚úÖ Deployment completed!"
        EOF

        rm -f deploy_key.pem
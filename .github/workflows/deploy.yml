name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to EC2
      run: |
        # Setup SSH key
        echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > key.pem
        chmod 600 key.pem

        # Deploy via SSH
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} '
          echo "ğŸš¢ Starting deployment..."

          # Stop old containers
          docker stop opd-api opd-web-admin opd-web-member 2>/dev/null || true
          docker rm opd-api opd-web-admin opd-web-member 2>/dev/null || true

          # Ensure network exists
          docker network create opdwallet_opd-network 2>/dev/null || true

          # Ensure MongoDB is running
          if ! docker ps | grep -q opd-mongo; then
            docker run -d --name opd-mongo \
              --network opdwallet_opd-network \
              -v mongo-data:/data/db \
              -p 27017:27017 \
              mongo:7.0
          fi

          # Start containers with existing images
          docker run -d --name opd-api \
            --network opdwallet_opd-network \
            -p 4000:4000 \
            -e NODE_ENV=production \
            -e MONGODB_URI=mongodb://opd-mongo:27017/opd_wallet \
            opdwallet-api:latest

          docker run -d --name opd-web-admin \
            --network opdwallet_opd-network \
            -e NODE_ENV=production \
            -e API_URL=http://opd-api:4000/api \
            opdwallet-web-admin:latest

          docker run -d --name opd-web-member \
            --network opdwallet_opd-network \
            -e NODE_ENV=production \
            -e API_URL=http://opd-api:4000/api \
            opdwallet-web-member:latest

          # Ensure nginx is running
          if ! docker ps | grep -q opd-nginx; then
            docker run -d --name opd-nginx \
              --network opdwallet_opd-network \
              -p 80:80 \
              -v /home/ubuntu/nginx.conf:/etc/nginx/nginx.conf:ro \
              nginx:alpine 2>/dev/null || true
          fi

          # Status check
          sleep 5
          echo ""
          echo "=== Deployment Status ==="
          docker ps --format "table {{.Names}}\t{{.Status}}"
          echo ""
          curl -sf http://localhost/health && echo "âœ… Health check passed!" || true
          echo "ğŸ‰ Deployment complete!"
        '

        # Cleanup
        rm -f key.pem

    - name: Summary
      if: always()
      run: |
        echo "======================================"
        echo "       DEPLOYMENT COMPLETED"
        echo "======================================"
        echo ""
        echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
        echo "ğŸ“± Member Portal: http://${{ secrets.EC2_HOST }}"
        echo "ğŸ‘¨â€ğŸ’¼ Admin Portal: http://${{ secrets.EC2_HOST }}/admin"
        echo "ğŸ”§ API: http://${{ secrets.EC2_HOST }}/api"
        echo ""
        echo "======================================="
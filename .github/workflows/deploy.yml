name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 55m
          script: |
            echo "ðŸš€ Starting deployment..."

            # Ensure we're in the right directory
            if [ -d ~/opdwallet ]; then
              cd ~/opdwallet
              echo "ðŸ“¥ Pulling latest code..."
              git pull origin main || git reset --hard origin/main
            else
              echo "ðŸ“ Cloning repository..."
              cd ~
              git clone https://github.com/anilkumar1510/opdwallet.git
              cd opdwallet
            fi

            # Ensure deployment script is executable
            chmod +x deploy-production.sh deploy-on-aws.sh 2>/dev/null || true

            # Try to stop any existing containers
            docker-compose -f docker-compose.prod.yml down 2>/dev/null || true

            # Clean up Docker to free memory
            docker system prune -af --volumes 2>/dev/null || true

            # Simple build and run
            echo "ðŸ”¨ Building and starting services..."
            docker-compose -f docker-compose.prod.yml up -d --build --remove-orphans

            # Wait for services
            sleep 30

            # Check status
            echo "ðŸ“Š Deployment status:"
            docker ps

            echo "âœ… Deployment attempt completed"
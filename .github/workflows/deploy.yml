name: Deploy Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY_BASE64 }}
      run: |
        echo "$EC2_SSH_KEY" | base64 -d > key.pem
        chmod 600 key.pem

        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@$EC2_HOST "
          set -e
          echo 'ðŸš€ Starting deployment...'

          # Clone or update repository using token
          if [ ! -d /home/ubuntu/opdwallet ]; then
            echo 'ðŸ“¥ Cloning repository...'
            cd /home/ubuntu
            git clone https://${{ secrets.GH_TOKEN }}@github.com/anilkumar1510/opdwallet.git
          fi

          cd /home/ubuntu/opdwallet
          git config --global --add safe.directory /home/ubuntu/opdwallet
          git pull https://${{ secrets.GH_TOKEN }}@github.com/anilkumar1510/opdwallet.git main

          if [ ! -f .env.production ]; then
            echo 'COOKIE_SECURE=false' > .env.production
            echo 'JWT_SECRET=your-secret-jwt-key' >> .env.production
            echo 'NODE_ENV=production' >> .env.production
            echo 'PUBLIC_API_URL=http://13.60.210.156/api' >> .env.production
            echo 'MONGO_DATABASE=opd_wallet' >> .env.production
            echo 'COOKIE_NAME=opd_session' >> .env.production
            echo 'COOKIE_HTTPONLY=true' >> .env.production
            echo 'COOKIE_SAMESITE=lax' >> .env.production
            echo 'COOKIE_MAX_AGE=604800000' >> .env.production
            echo 'MONGO_ROOT_USERNAME=admin' >> .env.production
            echo 'MONGO_ROOT_PASSWORD=password' >> .env.production
          fi

          docker-compose -f docker-compose.prod.yml down || true

          export DOCKER_DEFAULT_PLATFORM=linux/amd64
          docker-compose --env-file .env.production -f docker-compose.prod.yml build
          docker-compose --env-file .env.production -f docker-compose.prod.yml up -d

          sleep 15
          docker exec opd-api node dist/scripts/seed.js || true

          docker ps
          echo 'âœ… Deployment completed!'
        "

        rm -f key.pem
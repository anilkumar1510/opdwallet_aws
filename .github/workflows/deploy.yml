name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH Key
      run: |
        echo "Setting up SSH key..."
        echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > private_key.pem
        chmod 600 private_key.pem

        # Test connection
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i private_key.pem ubuntu@${{ secrets.EC2_HOST }} 'echo "‚úÖ SSH works"'

    # Skip building - just deploy with existing images on EC2

    - name: Deploy to EC2
      run: |
        echo "üö¢ Deploying to EC2..."

        ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e

          echo "Using existing Docker images on EC2..."
          docker images | grep opdwallet

          # Stop and remove old containers
          docker stop opd-api opd-web-admin opd-web-member 2>/dev/null || true
          docker rm opd-api opd-web-admin opd-web-member 2>/dev/null || true

          # Ensure network exists
          docker network create opdwallet_opd-network 2>/dev/null || true

          # Ensure MongoDB is running
          if ! docker ps | grep -q opd-mongo; then
            docker run -d --name opd-mongo \
              --network opdwallet_opd-network \
              -v mongo-data:/data/db \
              -p 27017:27017 \
              mongo:7.0
          fi

          # Start API (using existing local image)
          docker run -d --name opd-api \
            --network opdwallet_opd-network \
            -p 4000:4000 \
            -e NODE_ENV=production \
            -e MONGODB_URI=mongodb://opd-mongo:27017/opd_wallet \
            -e JWT_SECRET=your-super-secret-jwt-key-change-in-production \
            -e COOKIE_SECURE=false \
            -e COOKIE_HTTPONLY=true \
            -e CORS_ORIGIN='*' \
            opdwallet-api:latest || echo "API container failed to start"

          # Start Admin Portal (using existing local image)
          docker run -d --name opd-web-admin \
            --network opdwallet_opd-network \
            -e NODE_ENV=production \
            -e API_URL=http://opd-api:4000/api \
            -e NEXT_PUBLIC_API_URL=http://${{ secrets.EC2_HOST }}/api \
            opdwallet-web-admin:latest || echo "Admin container failed to start"

          # Start Member Portal (using existing local image)
          docker run -d --name opd-web-member \
            --network opdwallet_opd-network \
            -e NODE_ENV=production \
            -e API_URL=http://opd-api:4000/api \
            -e NEXT_PUBLIC_API_URL=http://${{ secrets.EC2_HOST }}/api \
            opdwallet-web-member:latest || echo "Member container failed to start"

          # Ensure nginx is running
          if ! docker ps | grep -q opd-nginx; then
            # Create nginx config if doesn't exist
            if [ ! -f /home/ubuntu/nginx.conf ]; then
              cat > /home/ubuntu/nginx.conf << 'NGINX_CONFIG'
events {
    worker_connections 1024;
}

http {
    upstream api {
        server opd-api:4000;
    }

    upstream admin {
        server opd-web-admin:3000;
    }

    upstream member {
        server opd-web-member:3001;
    }

    server {
        listen 80;
        server_name _;
        client_max_body_size 100M;

        location /api {
            proxy_pass http://api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /admin {
            proxy_pass http://admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://member;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
NGINX_CONFIG
            fi

            docker run -d --name opd-nginx \
              --network opdwallet_opd-network \
              -p 80:80 \
              -v /home/ubuntu/nginx.conf:/etc/nginx/nginx.conf:ro \
              nginx:alpine
          fi

          # Wait for services to start
          echo "Waiting for services to start..."
          sleep 10

          # Health check
          echo ""
          echo "=== Deployment Status ==="
          docker ps --format "table {{.Names}}\t{{.Status}}"
          echo ""

          if curl -sf http://localhost/health > /dev/null; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ö†Ô∏è  Health check failed (services may still be starting)"
          fi

          echo ""
          echo "üéâ Deployment completed successfully!"
ENDSSH

        # Cleanup
        rm -f private_key.pem

    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "======================================"
        echo "       DEPLOYMENT SUMMARY"
        echo "======================================"
        echo ""
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Status: SUCCESS"
          echo ""
          echo "üåê Application URLs:"
          echo "   Main: http://${{ secrets.EC2_HOST }}"
          echo "   Admin: http://${{ secrets.EC2_HOST }}/admin"
          echo "   API Docs: http://${{ secrets.EC2_HOST }}/api/docs"
        else
          echo "‚ùå Status: FAILED"
          echo ""
          echo "Check the logs above for error details."
        fi
        echo ""
        echo "======================================"